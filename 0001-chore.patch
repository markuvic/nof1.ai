From e48e1ad50bde780c26351324d80ec118b6d40304 Mon Sep 17 00:00:00 2001
From: 195440 <195440@qq.com>
Date: Mon, 3 Nov 2025 10:45:46 +0800
Subject: [PATCH] =?UTF-8?q?chore:=20=E6=9B=B4=E6=96=B0=E6=AD=A2=E6=8D=9F?=
 =?UTF-8?q?=E5=92=8C=E6=AD=A2=E7=9B=88=E7=AD=96=E7=95=A5=E8=AF=B4=E6=98=8E?=
 =?UTF-8?q?=EF=BC=8C=E5=A2=9E=E5=BC=BA=E4=BA=A4=E6=98=93=E5=86=B3=E7=AD=96?=
 =?UTF-8?q?=E7=9A=84=E7=81=B5=E6=B4=BB=E6=80=A7=E5=92=8C=E6=89=A7=E8=A1=8C?=
 =?UTF-8?q?=E5=8A=9B?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

- 调整止损策略的参数，更新低、中、高杠杆的止损线，确保更严格的风险控制。
- 增强止盈策略的灵活性，强调根据市场情况进行动态调整，避免死守目标。
- 更新相关决策逻辑，确保止损和止盈的执行符合最新策略要求。
---
 docs/STRATEGY_UPDATE_20251103.md | 185 +++++++++++++++++++++++++++++++
 src/agents/tradingAgent.ts       |  88 +++++++++------
 2 files changed, 241 insertions(+), 32 deletions(-)
 create mode 100644 docs/STRATEGY_UPDATE_20251103.md

diff --git a/docs/STRATEGY_UPDATE_20251103.md b/docs/STRATEGY_UPDATE_20251103.md
new file mode 100644
index 0000000..4748237
--- /dev/null
+++ b/docs/STRATEGY_UPDATE_20251103.md
@@ -0,0 +1,185 @@
+# 波段策略优化更新 - 2025年11月3日
+
+## 更新背景
+
+根据实际交易记录分析，发现波段策略存在以下问题：
+1. **止损过于紧密**：0.5%-2%就止损，远低于策略设定的5%-8%
+2. **止盈过于机械**：死守策略目标，错过了很多2%-3%的小盈利机会
+3. **持仓时间过短**：20-40分钟就平仓，不符合波段交易逻辑
+4. **胜率极低**：仅11.76%，远低于正常的30-40%
+
+结果：净亏损 -22.96 USDT，形成了"截断利润，让亏损奔跑"的反向交易模式。
+
+## 核心修改
+
+### 1. 止损参数调整（更宽松，给趋势更多空间）
+
+**修改前：**
+```typescript
+stopLoss: {
+  low: -8,    // 低杠杆：-8%止损
+  mid: -6,    // 中杠杆：-6%止损
+  high: -5,   // 高杠杆：-5%止损
+}
+```
+
+**修改后：**
+```typescript
+stopLoss: {
+  low: -10,   // 低杠杆(2-3倍)：-10%止损
+  mid: -8,    // 中杠杆(3-4倍)：-8%止损
+  high: -6,   // 高杠杆(4-5倍)：-6%止损
+}
+```
+
+**影响：**
+- 2-3倍杠杆：止损从-8%放宽到-10%，给趋势多25%的发展空间
+- 3-4倍杠杆：止损从-6%放宽到-8%，给趋势多33%的发展空间
+- 4-5倍杠杆：止损从-5%放宽到-6%，给趋势多20%的发展空间
+
+### 2. 止盈策略优化（灵活判断，不死守目标）
+
+#### 添加核心原则：
+```
+⚠️ 核心原则（必读）：
+• 止损 = 严格遵守：止损线是硬性规则，必须严格执行，仅可微调±1%
+• 止盈 = 灵活判断：止盈要根据市场实际情况决定，2-3%盈利也可止盈，不要死等高目标
+• 小确定性盈利 > 大不确定性盈利：宁可提前止盈，不要贪心回吐
+• 趋势是朋友，反转是敌人：出现反转信号立即止盈，不管盈利多少
+```
+
+#### 止盈判断标准（按优先级）：
+
+1. **趋势反转信号** → 立即全部止盈，不管盈利多少
+2. **阻力位/压力位附近** → 可提前止盈，哪怕只有2-3%
+3. **震荡行情，趋势不明确** → 有盈利就可以考虑止盈
+4. **持仓时间>4小时且盈利>2%** → 可主动止盈
+5. **盈利达到5-8%但趋势减弱** → 建议分批止盈50%
+6. **盈利达到10%+但出现回调迹象** → 建议至少止盈50%
+
+#### 明确策略目标仅供参考：
+- 策略中的止盈目标（+50%/+80%）仅供参考，不是必须等到的
+- 2%-3%的盈利也是有意义的波段
+- 记住：2%-3%的确定性盈利胜过10%的不确定性盈利！
+
+### 3. 止损规则强化（必须严格遵守）
+
+在提示词多个位置强调止损的强制性：
+
+1. **在策略说明部分**：
+   - 标题改为：`(1) 止损策略（⚠️ 必须严格遵守，这是保护本金的生命线）`
+   - 明确标注："止损线 XX%（必须执行）"
+   - 添加警告："触及止损线必须立即平仓，不要犹豫，不要等待反弹"
+
+2. **在决策流程部分**：
+   - 标题改为：`a) 止损决策（必须严格遵守，不可灵活）`
+   - 强调："⚠️ 重要：止损线是硬性规则，必须严格遵守，不像止盈可以灵活！"
+   - 明确微调限制：仅可微调±1%（不能更多）
+   - 添加警告："记住：止损是保护本金的生命线，不严格执行会导致大额亏损！"
+
+## 预期效果
+
+### 1. 减少过早止损
+- 原本0.5%-2%的正常回调不会再被止损
+- 给波段交易足够的发展空间
+- 降低因噪音波动导致的无效止损
+
+### 2. 提高止盈效率
+- AI会根据市场实际情况灵活止盈
+- 2%-3%的小盈利也会及时锁定
+- 避免"等待大目标导致利润回吐"的问题
+
+### 3. 改善风险收益比
+- **止损**：控制在6%-10%范围（根据杠杆）
+- **止盈**：灵活从2%到更高（根据市场）
+- **风险收益比**：预期从1:0.5提升到1:2以上
+
+### 4. 提高胜率
+- 预期胜率从11.76%提升到30-40%
+- 减少无效止损，增加有效止盈
+- 改善整体盈亏比
+
+## 操作建议
+
+### 1. 立即生效
+这些修改已经自动应用到交易系统中，下一个交易周期开始生效。
+
+### 2. 观察周期
+建议观察3-5天（约15-25个交易周期），评估效果：
+- 止损次数是否减少
+- 止盈效率是否提高
+- 胜率是否改善
+- 整体盈亏是否改善
+
+### 3. 监控指标
+重点关注：
+- **胜率**：应该从11.76%提升到30%+
+- **平均盈利**：应该从-1.35 USDT改善为正值
+- **最大回撤**：应该控制在账户的10-15%以内
+- **止损比例**：应该减少到30-40%
+
+### 4. 注意事项
+- ⚠️ 止损线虽然放宽，但必须严格遵守
+- ⚠️ 不要因为止损放宽就增加杠杆
+- ⚠️ 止盈灵活不等于随意，要有明确的市场依据
+- ⚠️ 建议初期使用2-3倍杠杆，观察效果后再考虑提高
+
+## 技术细节
+
+### 修改的文件
+- `/src/agents/tradingAgent.ts`
+
+### 修改的代码行
+1. 第194-198行：波段策略止损参数
+2. 第791-795行：核心原则说明
+3. 第797-807行：止损策略说明
+4. 第810-824行：止盈策略说明
+5. 第854-864行：止损决策流程
+6. 第872-885行：止盈决策流程
+
+### Git 提交建议
+```bash
+git add src/agents/tradingAgent.ts docs/STRATEGY_UPDATE_20251103.md
+git commit -m "feat: 优化波段策略止损止盈参数
+
+- 放宽止损线：low -8%→-10%, mid -6%→-8%, high -5%→-6%
+- 灵活止盈：2-3%盈利也可止盈，不死守高目标
+- 强化止损：必须严格遵守，仅可微调±1%
+- 目标：提高胜率从11.76%到30%+，改善盈亏比"
+```
+
+## 回测数据对比
+
+### 修改前（实际数据）
+- 交易笔数：17笔
+- 盈利交易：2笔 (+11.81 USDT)
+- 亏损交易：15笔 (-34.77 USDT)
+- 净盈亏：-22.96 USDT
+- 胜率：11.76%
+- 平均盈利：+5.91 USDT
+- 平均亏损：-2.32 USDT
+- 盈亏比：1:-0.39（极差）
+
+### 预期改善（修改后）
+- 交易笔数：预期减少20-30%（减少无效止损）
+- 胜率：提升到30-40%
+- 平均盈利：保持在+5-8 USDT
+- 平均亏损：增加到-3-4 USDT（但频率大幅降低）
+- 盈亏比：改善到1:1.5以上
+
+## 总结
+
+这次更新的核心思想是：
+
+1. **止损要宽松但严格**：给趋势足够空间，但触及必须执行
+2. **止盈要灵活但果断**：根据市场决策，小盈利也要珍惜
+3. **平衡风险收益**：宁可错过机会，不可贪心回吐
+
+这样的修改符合波段交易的本质：耐心等待，给趋势时间，灵活止盈，严格止损。
+
+---
+
+*文档创建时间：2025年11月3日*
+*修改人：AI Assistant*
+*版本：v1.0*
+
diff --git a/src/agents/tradingAgent.ts b/src/agents/tradingAgent.ts
index 28bfbfb..4440adf 100644
--- a/src/agents/tradingAgent.ts
+++ b/src/agents/tradingAgent.ts
@@ -192,9 +192,9 @@ export function getStrategyParams(strategy: TradingStrategy): StrategyParams {
         strong: "18-20%",
       },
       stopLoss: {
-        low: -8,    // 低杠杆：-8%止损（给趋势足够空间）
-        mid: -6,    // 中杠杆：-6%止损
-        high: -5,   // 高杠杆：-5%止损
+        low: -10,   // 低杠杆(2-3倍)：-10%止损（给趋势足够空间）
+        mid: -8,    // 中杠杆(3-4倍)：-8%止损
+        high: -6,   // 高杠杆(4-5倍)：-6%止损
       },
       trailingStop: {
         // 波段策略：给趋势更多空间，较晚锁定利润
@@ -788,13 +788,22 @@ function generateInstructions(strategy: TradingStrategy, intervalMinutes: number
   
   【AI战术决策 - 专业建议，灵活执行】：
   
-  (1) 止损策略（专业风控建议）：
-     * 策略止损线（基于统计优化，强烈建议遵守）：
-       - ${params.leverageMin}-${Math.floor((params.leverageMin + params.leverageMax) / 2)}倍杠杆：建议止损 ${params.stopLoss.low}%
-       - ${Math.floor((params.leverageMin + params.leverageMax) / 2)}-${Math.ceil((params.leverageMin + params.leverageMax) * 0.75)}倍杠杆：建议止损 ${params.stopLoss.mid}%
-       - ${Math.ceil((params.leverageMin + params.leverageMax) * 0.75)}-${params.leverageMax}倍杠杆：建议止损 ${params.stopLoss.high}%
-     * 灵活调整：可根据关键支撑位、趋势强度微调±1-2%
-     * 重要警告：突破止损线后继续持有，需有充分理由（如测试关键支撑、假突破）
+  核心原则（必读）：
+  • 止损 = 严格遵守：止损线是硬性规则，必须严格执行，仅可微调±1%
+  • 止盈 = 灵活判断：止盈要根据市场实际情况决定，2-3%盈利也可止盈，不要死等高目标
+  • 小确定性盈利 > 大不确定性盈利：宁可提前止盈，不要贪心回吐
+  • 趋势是朋友，反转是敌人：出现反转信号立即止盈，不管盈利多少
+  
+  (1) 止损策略（必须严格遵守，这是保护本金的生命线）：
+     * 策略止损线（必须遵守，不可随意突破）：
+       - ${params.leverageMin}-${Math.floor((params.leverageMin + params.leverageMax) / 2)}倍杠杆：止损线 ${params.stopLoss.low}%（必须执行）
+       - ${Math.floor((params.leverageMin + params.leverageMax) / 2)}-${Math.ceil((params.leverageMin + params.leverageMax) * 0.75)}倍杠杆：止损线 ${params.stopLoss.mid}%（必须执行）
+       - ${Math.ceil((params.leverageMin + params.leverageMax) * 0.75)}-${params.leverageMax}倍杠杆：止损线 ${params.stopLoss.high}%（必须执行）
+     * 微调空间：仅可根据关键支撑位/阻力位微调±1%（不能超过）
+     * 重要警告：
+       - 触及止损线必须立即平仓，不要犹豫，不要等待反弹
+       - 突破止损线后继续持有将导致更大亏损
+       - 极少例外：仅限明确的假突破+关键支撑位（需要充分证据）
      * 说明：pnl_percent已包含杠杆效应，直接比较即可
   
   (2) 移动止盈策略（保护利润的核心机制，强烈建议执行）：
@@ -807,17 +816,21 @@ function generateInstructions(strategy: TradingStrategy, intervalMinutes: number
        - 震荡行情：应严格执行，避免利润回吐
      * 说明：这些阈值已针对您的杠杆范围（${params.leverageMin}-${params.leverageMax}倍）优化
   
-  (3) 分批止盈策略（专业获利技巧）：
-     * ${params.name}策略的分批止盈建议（已根据${params.leverageMax}倍最大杠杆优化）：
-       - 盈利 ≥ +${params.partialTakeProfit.stage1.trigger}% → 建议平仓${params.partialTakeProfit.stage1.closePercent}%（锁定一半利润，让剩余持仓追求更高收益）
-       - 盈利 ≥ +${params.partialTakeProfit.stage2.trigger}% → 建议平仓剩余${params.partialTakeProfit.stage2.closePercent}%（累计平仓100%）
-       - 盈利 ≥ +${params.partialTakeProfit.stage3.trigger}% → 建议全部清仓（避免贪婪导致利润回吐）
+  (3) 止盈策略（灵活决策，不要死板）：
+     * 重要原则：止盈要灵活，根据实际市场情况决定！
+       - 策略中的止盈目标（+${params.partialTakeProfit.stage1.trigger}%/+${params.partialTakeProfit.stage2.trigger}%/+${params.partialTakeProfit.stage3.trigger}%）仅供参考，不是硬性规则
+       - 2%-3%的盈利也是有意义的波段，不要贪心等待大目标
+       - 根据市场实际情况灵活决策：
+         * 趋势减弱/出现反转信号 → 立即止盈，哪怕只有2-3%
+         * 震荡行情、阻力位附近 → 可以提前止盈，落袋为安
+         * 趋势强劲、没有明显阻力 → 可以让利润继续奔跑
+         * 持仓时间已久(4小时+)且有盈利 → 考虑主动止盈
+     * 参考建议（仅供参考，不是强制）：
+       - 盈利 ≥ +${params.partialTakeProfit.stage1.trigger}% → 可考虑平仓${params.partialTakeProfit.stage1.closePercent}%
+       - 盈利 ≥ +${params.partialTakeProfit.stage2.trigger}% → 可考虑平仓剩余${params.partialTakeProfit.stage2.closePercent}%
      * 执行方式：使用 closePosition 的 percentage 参数
        - 示例：closePosition(symbol: 'BTC', percentage: 50) 可平掉50%仓位
-     * 灵活调整：
-       - 强趋势：可推迟触发（等待更高利润）
-       - 震荡行情：可提前触发（尽早锁定利润）
-     * 说明：这些阈值已针对您的杠杆范围（${params.leverageMin}-${params.leverageMax}倍）优化
+     * 记住：小的确定性盈利 > 大的不确定性盈利！
   
   (4) 峰值回撤保护（危险信号）：
      * ${params.name}策略的峰值回撤阈值：${params.peakDrawdownProtection}%（已根据风险偏好优化）
@@ -847,14 +860,17 @@ function generateInstructions(strategy: TradingStrategy, intervalMinutes: number
    - 立即调用 getPositions 获取所有持仓信息
    - 对每个持仓进行专业分析和决策（每个决策都要实际执行工具）：
    
-   a) 止损决策：
+   a) 止损决策（必须严格遵守，不可灵活）：
+      - 重要：止损线是硬性规则，必须严格遵守，不像止盈可以灵活！
       - 检查 pnl_percent 是否触及策略止损线：
-        * ${params.leverageMin}-${Math.floor((params.leverageMin + params.leverageMax) / 2)}倍杠杆：建议止损 ${params.stopLoss.low}%
-        * ${Math.floor((params.leverageMin + params.leverageMax) / 2)}-${Math.ceil((params.leverageMin + params.leverageMax) * 0.75)}倍杠杆：建议止损 ${params.stopLoss.mid}%
-        * ${Math.ceil((params.leverageMin + params.leverageMax) * 0.75)}-${params.leverageMax}倍杠杆：建议止损 ${params.stopLoss.high}%
-      - 可根据关键支撑位、趋势强度微调±1-2%
-      - 如果触及或突破止损线，除非有充分理由（关键支撑、假突破）
-      - 立即调用 closePosition 平仓（不要只说"应该平仓"）
+        * ${params.leverageMin}-${Math.floor((params.leverageMin + params.leverageMax) / 2)}倍杠杆：止损线 ${params.stopLoss.low}%（必须遵守）
+        * ${Math.floor((params.leverageMin + params.leverageMax) / 2)}-${Math.ceil((params.leverageMin + params.leverageMax) * 0.75)}倍杠杆：止损线 ${params.stopLoss.mid}%（必须遵守）
+        * ${Math.ceil((params.leverageMin + params.leverageMax) * 0.75)}-${params.leverageMax}倍杠杆：止损线 ${params.stopLoss.high}%（必须遵守）
+      - 微调空间：仅可根据关键支撑位/阻力位微调±1%（不能更多）
+      - 如果触及或突破止损线：
+        * 立即调用 closePosition 平仓（不要犹豫，不要等待）
+        * 例外情况极少：仅限明确的假突破+关键支撑位
+      - 记住：止损是保护本金的生命线，不严格执行会导致大额亏损！
    
    b) 移动止盈决策：
       - 检查是否达到移动止盈触发点（+${params.trailingStop.level1.trigger}%/+${params.trailingStop.level2.trigger}%/+${params.trailingStop.level3.trigger}%）
@@ -862,12 +878,20 @@ function generateInstructions(strategy: TradingStrategy, intervalMinutes: number
       - 如果当前盈利回落到移动止损线以下
       - 立即调用 closePosition 平仓保护利润（不要犹豫）
    
-   c) 分批止盈决策：
-      - 检查是否达到分批止盈点（+${params.partialTakeProfit.stage1.trigger}%/+${params.partialTakeProfit.stage2.trigger}%/+${params.partialTakeProfit.stage3.trigger}%）
-      - 评估趋势强度，决定是否分批止盈
-      - 如果决定分批止盈
-      - 立即调用 closePosition 的 percentage 参数部分平仓
-      - 示例：closePosition({ symbol: 'BTC', percentage: ${params.partialTakeProfit.stage1.closePercent} }) 平掉${params.partialTakeProfit.stage1.closePercent}%仓位
+   c) 止盈决策（灵活判断，不要死守目标）：
+      - 重要：止盈要根据市场实际情况灵活决策，不要死板！
+      - 止盈判断标准（按优先级）：
+        * 趋势反转信号 → 立即全部止盈，不管盈利多少
+        * 阻力位/压力位附近 → 可提前止盈，哪怕只有2-3%
+        * 震荡行情，趋势不明确 → 有盈利就可以考虑止盈
+        * 持仓时间>4小时且盈利>2% → 可主动止盈
+        * 盈利达到5-8%但趋势减弱 → 建议分批止盈50%
+        * 盈利达到10%+但出现回调迹象 → 建议至少止盈50%
+      - 策略目标（+${params.partialTakeProfit.stage1.trigger}%/+${params.partialTakeProfit.stage2.trigger}%）仅供参考，不是必须等到的
+      - 执行方式：
+        * 全部止盈：closePosition({ symbol: 'BTC' })
+        * 部分止盈：closePosition({ symbol: 'BTC', percentage: 50 })
+      - 记住：2%-3%的确定性盈利胜过10%的不确定性盈利！
    
    d) 峰值回撤检查：
       - 检查 peak_pnl_percent（历史最高盈利）
-- 
2.34.1

